!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=2)}([function(e,t,n){t.rot_x=e=>{const t=n(1).getMatrix(4,4);return t.setValue(0,0,1),t.setValue(1,1,Math.cos(e)),t.setValue(2,1,-Math.sin(e)),t.setValue(1,2,Math.sin(e)),t.setValue(2,2,Math.cos(e)),t.setValue(3,3,1),t},t.rot_y=e=>{const t=n(1).getMatrix(4,4);return t.setValue(0,0,Math.cos(e)),t.setValue(2,0,Math.sin(e)),t.setValue(1,1,1),t.setValue(0,2,-Math.sin(e)),t.setValue(2,2,Math.cos(e)),t.setValue(3,3,1),t},t.rot_z=e=>{const t=n(1).getMatrix(4,4);return t.setValue(0,0,Math.cos(e)),t.setValue(1,0,-Math.sin(e)),t.setValue(0,1,Math.sin(e)),t.setValue(1,1,Math.cos(e)),t.setValue(2,2,1),t.setValue(3,3,1),t}},function(e,t){t.getMatrix=(e,t)=>new n(e,t);class n{constructor(e,t){this.m=e,this.n=t,this.init()}getArray(){const e=[];for(let t=0;t<this.m;t++)for(let n=0;n<this.n;n++)e[t+this.m*n]=this.matrix[t][n];return e}check(e,t){if(e<0||e>=this.m||t<0||t>=this.n)throw new Error("範囲外")}init(){this.matrix=[];for(let e=0;e<this.m;e++){this.matrix[e]=[];for(let t=0;t<this.n;t++)this.matrix[e][t]=0}}setValue(e,t,n){this.check(e,t),this.matrix[e][t]=n}getValue(e,t){return this.check(e,t),this.matrix[e][t]}mul(e){if(this.n!=e.m)throw new Error("サイズの不一致");const t=new n(this.m,e.n);for(let n=0;n<this.m;n++)for(let o=0;o<e.n;o++)t.setValue(n,o,r(n,o,this,e));return t;function r(e,t,n,r){let o=0;for(let i=0;i<n.n;i++)o+=n.getValue(e,i)*r.getValue(i,t);return o}}}},function(e,t,n){window.onload=()=>{const e=document.getElementById("canvas");e.width=500,e.height=500;const t=e.getContext("webgl2");t.getExtension("OES_texture_float_linear"),t.getExtension("EXT_color_buffer_float");const r=512,o=[],i=[],a=[],u=[];for(let e=0;e<r;e++){o.push(2*Math.random()-1),o.push(2*Math.random()-1),o.push(2*Math.random()-1),o.push(1);for(let e=0;e<4;e++)i.push(0),a.push(0);u.push(100),u.push(0),u.push(0),u.push(0)}const s=new Float32Array(o),l=new Float32Array(i),c=new Float32Array(a);function f(e,n,r,o,i){const a=t.createTexture();return t.bindTexture(t.TEXTURE_2D,a),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,r,e.length/n,1,0,o,i,e),t.bindTexture(t.TEXTURE_2D,null),a}const T=f(new Float32Array(u),4,t.RGBA32F,t.RGBA,t.FLOAT),m=[],E=[],_=[];function d(e,n){const r=t.createShader(e);if(t.shaderSource(r,n),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(r));return r}m[0]=f(s,4,t.RGBA32F,t.RGBA,t.FLOAT),E[0]=f(l,4,t.RGBA32F,t.RGBA,t.FLOAT),_[0]=f(c,4,t.RGBA32F,t.RGBA,t.FLOAT),m[1]=f(s,4,t.RGBA32F,t.RGBA,t.FLOAT),E[1]=f(l,4,t.RGBA32F,t.RGBA,t.FLOAT),_[1]=f(c,4,t.RGBA32F,t.RGBA,t.FLOAT);const h=t.createProgram(),R=d(t.VERTEX_SHADER,n(3).default);t.attachShader(h,R);const v=d(t.FRAGMENT_SHADER,n(4).default);t.attachShader(h,v),t.linkProgram(h);const x=t.createProgram(),A=d(t.VERTEX_SHADER,n(5).default);t.attachShader(x,A);const g=d(t.FRAGMENT_SHADER,n(6).default);t.attachShader(x,g),t.linkProgram(x),t.useProgram(h);const F=t.getUniformLocation(h,"N");t.uniform1f(F,r);const p=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,p);let M=null,U=null,P=n(0).rot_x(0);e.addEventListener("mousemove",(function(e){null!=M&&null!=U||(M=e.offsetX,U=e.offsetY);const r=e.offsetX-M,o=e.offsetY-U;M=e.offsetX,U=e.offsetY;const i=n(0).rot_x(.01*o),a=n(0).rot_y(.01*r);P=i.mul(a).mul(P),t.useProgram(x);let u=t.getUniformLocation(x,"rot");t.uniformMatrix4fv(u,!1,P.getArray())}),!1),t.useProgram(x);const O=n(0).rot_x(0),S=n(0).rot_y(0);P=O.mul(S).mul(P);let b=t.getUniformLocation(x,"rot");t.uniformMatrix4fv(b,!1,P.getArray()),function e(){t.useProgram(h);t.viewport(0,0,r,1);t.bindFramebuffer(t.FRAMEBUFFER,p);t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,m[1],0);t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT1,t.TEXTURE_2D,E[1],0);t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT2,t.TEXTURE_2D,_[1],0);t.drawBuffers([t.COLOR_ATTACHMENT0,t.COLOR_ATTACHMENT1,t.COLOR_ATTACHMENT2]);t.activeTexture(t.TEXTURE0);t.bindTexture(t.TEXTURE_2D,m[0]);t.uniform1i(t.getUniformLocation(h,"p"),0);t.activeTexture(t.TEXTURE1);t.bindTexture(t.TEXTURE_2D,E[0]);t.uniform1i(t.getUniformLocation(h,"v"),1);t.activeTexture(t.TEXTURE2);t.bindTexture(t.TEXTURE_2D,_[0]);t.uniform1i(t.getUniformLocation(h,"a"),2);t.activeTexture(t.TEXTURE3);t.bindTexture(t.TEXTURE_2D,T);t.uniform1i(t.getUniformLocation(h,"m"),3);t.drawArrays(t.POINTS,0,r);m.reverse();E.reverse();_.reverse();t.useProgram(x);t.bindFramebuffer(t.FRAMEBUFFER,null);t.viewport(0,0,500,500);t.clearColor(0,0,0,1);t.clear(t.COLOR_BUFFER_BIT);t.activeTexture(t.TEXTURE0);t.bindTexture(t.TEXTURE_2D,m[0]);t.uniform1i(t.getUniformLocation(x,"p"),0);t.drawArrays(t.POINTS,0,r);setTimeout(e,5)}()}},function(e,t,n){"use strict";n.r(t),t.default="#version 300 es\n\nuniform float N;\n\nvoid main() {\n\tgl_Position = vec4(2.0 * float(gl_VertexID) / N + 1.0 / N - 1.0, 0.0, 0.0, 1.0);\n\tgl_PointSize = 1.0;\n}"},function(e,t,n){"use strict";n.r(t),t.default="#version 300 es\n\nprecision mediump float;\n\nuniform sampler2D m;\nuniform sampler2D p;\nuniform sampler2D v;\nuniform sampler2D a;\nlayout(location = 0) out vec4 new_p;\nlayout(location = 1) out vec4 new_v;\nlayout(location = 2) out vec4 new_a;\n\nconst float G = 6.67408e-11;\nconst float TIME_STEP = 0.5;\n\nvoid main() {\n  vec4 old_p = texelFetch(p, ivec2(gl_FragCoord.x, 0), 0);\n  vec4 old_v = texelFetch(v, ivec2(gl_FragCoord.x, 0), 0);\n  vec4 old_a = texelFetch(a, ivec2(gl_FragCoord.x, 0), 0);\n  int size = textureSize(m, 0).x;\n  vec3 force = vec3(0.0, 0.0, 0.0);\n\n  // 万有引力計算\n  for (int i = 0; i < size; i++) {\n    if (i == int(gl_FragCoord.x)) {\n      continue;\n    }\n    vec4 pos = texelFetch(p, ivec2(i, 0), 0);\n    float mass = texelFetch(m, ivec2(i, 0), 0).x;\n    vec3 relative = vec3(pos.xyz - old_p.xyz);\n    float norm = length(relative);\n    // 近すぎる時に、強烈に加速するのを防止する\n    if (norm > 0.01) {\n      float invnorm = 1.0 / pow(norm, 3.0);\n      force += G * mass * invnorm * relative;\n    }\n  }\n\n  // リープフロッグ法で質点の情報を更新\n  vec4 middle = old_v + (TIME_STEP / 2.0) * old_a;\n  new_a = vec4(force, 0.0);\n  new_p = old_p + TIME_STEP * middle;\n  new_v = old_v + (TIME_STEP / 2.0) * (old_a + new_a);\n}"},function(e,t,n){"use strict";n.r(t),t.default="#version 300 es\n\nuniform mat4 rot;\nuniform sampler2D p;\n\nvoid main() {\n\tgl_Position = rot * texelFetch(p, ivec2(gl_VertexID, 0), 0);\n\tgl_PointSize = 5.0;\n}"},function(e,t,n){"use strict";n.r(t),t.default="#version 300 es\n\nprecision mediump float;\nout vec4 color;\n\nvoid main(void) {\n\t// 円を描画する\n    if (distance(gl_PointCoord, vec2(0.5, 0.5)) < 0.5) {\n        color = vec4(1.0, 1.0, 1.0, 1.0);\n    } else {\n\t\t// 円の外側にあるピクセルは破棄\n        discard;\n    }\n}"}]);